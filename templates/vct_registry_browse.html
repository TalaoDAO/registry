<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VCT Registry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}">
  <style>
    :root{ --blue:#1a73e8; --blue-dark:#1558b0; --surface:#ffffff; --border:#e3e3e3;
           --text:#202124; --subtext:#5f6368; --bg:#f8f9fa; --ok:#166534; --err:#991b1b; }
    body { margin:0; background:#f7f9fc; color:#333; font-family: Arial, sans-serif; }

    .section { max-width:1800px; margin:4rem auto; padding:0 2rem; }
    .card { width:100%; max-width:1650px; margin:0 auto; background:var(--surface); border:1px solid var(--border);
            border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.06); overflow:hidden; }
    .card-header { display:flex; align-items:center; gap:.75rem; padding:1rem 1.25rem; border-bottom:1px solid var(--border); }
    .app-mark { width:28px; height:28px; border-radius:6px; background:#1a73e8; display:grid; place-content:center; color:#fff; font-weight:700; font-size:.95rem; }
    .title { margin:0; font-size:1rem; font-weight:700; font-family:'Roboto'; }
    .subtitle { margin:0; font-size:.9rem; color:var(--subtext); font-weight:400; font-family:'Roboto'; }

    .card-body { padding:1.25rem; display:grid; gap:1rem; }
    .note { color:var(--subtext); font-size:.9rem; }

    .primary-btn, .secondary-btn, .ghost-btn { appearance:none; border:none; cursor:pointer; text-decoration:none;
      padding:.8rem 1rem; border-radius:8px; font-weight:600; display:inline-flex; align-items:center; gap:.5rem;
      font-family:'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
    .primary-btn { background:var(--blue); color:#fff; }
    .primary-btn:hover { background:var(--blue-dark); }
    .secondary-btn { background:#edf2ff; color:#1f3b8a; border:1px solid #c7d2fe; }
    .ghost-btn { background:transparent; color:#111827; border:1px dashed var(--border); }

    input[type="text"], select { padding:.6rem .7rem; border:1px solid var(--border); border-radius:8px; min-width:220px; }
    input[type="number"] { padding:.6rem .7rem; border:1px solid var(--border); border-radius:8px; width:110px; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:.75rem 1rem; border-top:1px solid var(--border); text-align:left; font-size:.95rem; vertical-align: middle; }
    th { background:#f3f4f6; position:sticky; top:0; z-index:1; }
    tbody tr:hover { background:#fafafa; }

    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .row-actions { display:flex; gap:.5rem; align-items:center; flex-wrap:nowrap; white-space:nowrap; overflow:auto; }

    .toolbar { display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .toolbar .left, .toolbar .right { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }

    /* READ-ONLY STARS */
    .stars { display:inline-flex; gap:2px; user-select:none; cursor: default; }
    .star { font-size:1.1rem; color:#d1d5db; }
    .star.filled { color:#f59e0b; }

    .overlay { position:fixed; inset:0; background:rgba(255,255,255,.7); backdrop-filter: blur(2px);
               display:none; align-items:center; justify-content:center; z-index:50; }
    .spinner { width:46px; height:46px; border-radius:999px; border:4px solid #d1d5db; border-top-color:var(--blue);
               animation: spin 1s linear infinite; }

    @keyframes spin { to { transform: rotate(360deg); } }

    .count { color:var(--subtext); font-size:.9rem; }

    .chips { display:flex; gap:.35rem; flex-wrap:wrap; align-items:center; }
    .chip { padding:.25rem .55rem; border:1px solid var(--border); border-radius:999px; font-size:.85rem; background:#fff; }
    .hint { color:#6b7280; font-size:.9rem; padding:1rem; }

    .filters { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    
    /* Scrollable claim list that won't exceed the card's height */
    .claims-scroll {
      overflow: auto;
      padding-right: .5rem;            /* keep scrollbar off text */
    }
    .claim-item {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: .9rem;
      line-height: 1.3;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    /* ---- VCT Card column ---- */
    .vct-card {
      aspect-ratio: 85.6 / 53.98; /* ~1.586, ID-1 bank card ratio */
      width: 260px;
      max-width: 300px;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      display: grid;
      align-items: end;
      padding: .75rem .9rem;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
      background-size: cover;
      background-position: center;
      border: 1px solid #e5e7eb;
      text-decoration: none; /* ensure no underline when inside <a> */
      transition: transform .12s ease, box-shadow .12s ease;
      cursor: pointer;
    }
    .vct-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 28px rgba(0,0,0,.12);
    }
    .vct-card .vct-name {
      font-weight: 700;
      line-height: 1.2;
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      font-size: .95rem;
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0,0,0,.2);
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .vct-card .logo-wrap {
      position: absolute;
      top: .55rem;
      left: .55rem; /* logo on the left */
      min-width: 44px;
      height: 44px;
      border-radius: 10px;
      background: rgba(255,255,255,.85);
      display: grid;
      place-content: center;
      padding: 4px 8px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.06);
      box-sizing: border-box;
    }
    .vct-card .logo-wrap img {
      max-width: 80%;
      max-height: 80%;
      display: block;
      object-fit: contain;
    }
    .vct-card .logo-wrap span {
      font-size: .75rem;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
    }
    .vct-card::after {
      /* subtle gradient to improve text readability on images */
      content: "";
      position: absolute;
      inset: 0 0 0 0;
      background: linear-gradient(to top, rgba(0,0,0,.28), rgba(0,0,0,.0) 60%);
      pointer-events: none;
    }

    /* Toast for copy feedback */
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #111827;
      color: #fff;
      padding: .6rem .8rem;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .2s ease, transform .2s ease;
      z-index: 1000;
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      font-size: .9rem;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
  
    /* Popular filter pills */
    .pill-grid { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.25rem; }
    .pill {
      display:inline-flex; align-items:center; gap:.4rem;
      border:1px solid var(--border); border-radius:999px; padding:.4rem .65rem;
      background:#fff; cursor:pointer; user-select:none;
      font-family:'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif; font-size:.9rem;
    }
    .pill input { appearance:none; width:14px; height:14px; border:1px solid #94a3b8; border-radius:3px; display:inline-block; }
    .pill input:checked { background:var(--blue); border-color:var(--blue); }
    .pill.active { border-color:#93c5fd; background:#eff6ff; }
    @media (prefers-color-scheme: dark) {
      .pill { background:#0f172a; }
    }
    
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <strong><a href="/" style="color: var(--primary); text-decoration: none;">VC-REGISTRY.COM</a></strong>
    </div>
    <div class="nav-group">
      <nav>
        <a href="/menu">Tools</a>
        <a href="/vct/registry/manage">My VC Types</a>
        <a href="/documentation/vct_registry_browse" target="_blank" rel="noopener">Explain ?</a>
      </nav>
      {% include "account.html" %}
    </div>
  </header>
  <section class="section">
    <div class="card">
      <div class="card-header">
        <div class="app-mark">V</div> 
        <div style="display:flex; flex-direction:column;">
          <h2 class="title">VCT Registry</h2>
          <p class="subtitle">Browse and search public Verified Credential Types</p>
        </div>
      </div>

      <div class="card-body">
        <div class="toolbar">
          <div class="left">
            <select id="scope" title="Visibility">
              <option value="public" selected>Public</option>
            </select>

            <input id="search" type="text" placeholder="Search name, description, properties, claims…" />
            <label><input id="ai-toggle" type="checkbox" /> AI search</label>
            <button id="search-btn" class="primary-btn">Search</button>
            <button id="reset-btn" class="ghost-btn">Reset</button>
          </div>

          <div class="right">
            <div class="filters">
              <select id="sort" title="Sort by">
                <option value="rating">Highest rating</option>
                <option value="calls">Most called</option>
                <option value="newest">Newest</option>
                <option value="name">A–Z</option>
              </select>

              <input id="languages" type="text" placeholder="Languages (e.g. en,fr)" title="Comma-separated list, matches languages_supported" />
              <input hidden id="prop" type="text" placeholder="Schema property contains…" /> 
              <input id="claim" type="text" placeholder="Claim path contains…" />
              <input id="min_rating" type="number" min="0" max="5" step="0.1" placeholder="Min ★" />
              <input id="min_calls" type="number" min="0" step="1" placeholder="Min calls" />
              <label hidden title="Only entries with a JSON Schema"><input hidden id="has_schema" type="checkbox" /> Has schema</label>
            </div>
          </div>
        </div>

        <!-- Popular filters (single-select) -->
        <div class="row" id="popular-filters">
          <label>Popular filters</label>
          <div class="pill-grid" id="filter-grid" role="group" aria-label="Popular filters"></div>
          <div class="note" id="filters-note" style="min-height:1.2em;"></div>
        </div>

        <div>
          <span id="result-count" class="count"></span>
        </div>

        <div style="overflow:auto; border:1px solid var(--border); border-radius:8px;">
          <table>
            <thead>
             <tr>
              <th style="width:20%;">Display</th>
              <th style="width:10%;">Name</th>
              <th style="width:30%;">Description</th>
              <th style="width:10%;">Claims</th>
              <th style="width:10%;">Languages</th>
              <th style="width:5%;">Popularity</th>
              <th style="width:15%;">Actions</th>
            </tr>

            </thead>
            <tbody id="rows">
              <tr id="empty-row"><td colspan="7"><div class="hint">No results. Try a property like <span class="chip">given_name</span> or a claim path like <span class="chip">person/birthdate</span>.</div></td></tr>
            </tbody>
          </table>
        </div>

        <div id="upload-status" class="note"></div>
      </div>
    </div>
  </section>

  <div id="overlay" class="overlay">
    <div style="display:flex; flex-direction:column; align-items:center; gap:.75rem;">
      <div class="spinner"></div>
      <div class="mono">Working…</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const rows = $('rows');
    const emptyRow = $('empty-row');
    const overlay = $('overlay');
    const scopeSel = $('scope');
    const searchInput = $('search');
    const aiToggle = $('ai-toggle');
    const searchBtn = $('search-btn');
    const resetBtn = $('reset-btn');
    const resultCount = $('result-count');

    const sortSel = $('sort');
    const languagesInput = $('languages');
    const propInput = $('prop');
    const claimInput = $('claim');
    const minRatingInput = $('min_rating');
    const minCallsInput = $('min_calls');
    const hasSchemaInput = $('has_schema');

    // Track pairs of (cardEl, claimsWrap) to recompute heights on resize
    const _resizePairs = [];
    window.addEventListener('resize', () => {
      for (const { cardEl, claimsWrap } of _resizePairs) {
        if (cardEl && claimsWrap) {
          const h = cardEl.clientHeight || 0;
          if (h) claimsWrap.style.maxHeight = h + 'px';
        }
      }
    });


    function overlayOn(on){ overlay.style.display = on ? 'flex' : 'none'; }

    function showToast(msg){
      try{
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        requestAnimationFrame(() => t.classList.add('show'));
        setTimeout(() => {
          t.classList.remove('show');
          setTimeout(() => t.remove(), 250);
        }, 1500);
      }catch(e){ /* no-op */ }
    }

    async function copyText(text){
      const s = String(text || '');
      if (!s) return false;
      try{
        if (navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(s);
          return true;
        }
      }catch(e){ /* fallthrough */ }
      try{
        const ta = document.createElement('textarea');
        ta.value = s;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.top = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return !!ok;
      }catch(e){
        return false;
      }
    }

    // ---- Stars (READ-ONLY)
    function starEl(filled){ const el = document.createElement('span'); el.className = 'star' + (filled ? ' filled':'' ); el.textContent = '★'; return el; }
    function renderStarsCell(item){
      const wrap = document.createElement('div');
      const stars = document.createElement('div'); stars.className = 'stars';
      const rounded = Math.round((item.avg_rating || 0));
      for (let i=1;i<=5;i++){
        const el = starEl(i <= rounded);
        el.title = `Average: ${(item.avg_rating||0).toFixed(1)}★ from ${item.ratings_count||0} ratings`;
        stars.appendChild(el);
      }
      const meta = document.createElement('div');
      meta.className='note';
      const calls = (item.calls_count||0);
      meta.textContent = `${(item.avg_rating||0).toFixed(1)}★ • ${item.ratings_count||0} ratings • ${calls} calls`;
      wrap.appendChild(stars); wrap.appendChild(meta);
      return wrap;
    }

    // ---- Helpers
    function safeUrl(u){
      try {
        const s = String(u || '').trim();
        if (!s) return '';
        // allow data: and blob: URIs
        if (s.startsWith('data:') || s.startsWith('blob:')) return s;
        const url = new URL(s, window.location.origin);
        return url.href;
      } catch(e){ return ''; }
    }
    function getBackgroundImage(item){
      // Handle expected key and a possible legacy typo
      return item.background_image_uri || item["background image_uri"] || '';
    }

    function buildVCTCard(item){
      const textColor = String(item.text_color || '#ffffff');
      const bgColor = String(item.background_color || '');
      const bgImage = safeUrl(getBackgroundImage(item));
      const logo = safeUrl(item.logo_uri || '');
      const bgAlt = item.background_image_alt_text || '';
      const logoAlt = item.logo_alt_text || '';

      // Visual card
      const cardDiv = document.createElement('div');
      cardDiv.className = 'vct-card';

      // Background: image → alt text → color → initials
      if (bgImage){
        cardDiv.style.backgroundImage = `url("${bgImage}")`;
        cardDiv.style.backgroundColor = bgColor || '#e5e7eb'; // fallback while image loads
      } else if (bgAlt){
        cardDiv.style.background = '#e5e7eb';
        const altEl = document.createElement('div');
        altEl.style.position = 'absolute';
        altEl.style.inset = 0;
        altEl.style.display = 'flex';
        altEl.style.alignItems = 'center';
        altEl.style.justifyContent = 'center';
        altEl.style.fontSize = '1rem';
        altEl.style.fontWeight = '600';
        altEl.style.color = '#374151';
        altEl.textContent = bgAlt;
        cardDiv.appendChild(altEl);
      } else if (bgColor) {
        cardDiv.style.background = bgColor;
      } else {
        // No background image, alt text, or color → initials
        cardDiv.style.background = '#e5e7eb';
        const initials = (item.name || 'VC')
          .split(/\s+/)
          .map(w => w[0])
          .join('')
          .substring(0, 3)
          .toUpperCase();
        const placeholder = document.createElement('div');
        placeholder.style.position = 'absolute';
        placeholder.style.inset = 0;
        placeholder.style.display = 'flex';
        placeholder.style.alignItems = 'center';
        placeholder.style.justifyContent = 'center';
        placeholder.style.fontSize = '1.2rem';
        placeholder.style.fontWeight = '700';
        placeholder.style.color = '#374151';
        placeholder.textContent = initials;
        cardDiv.appendChild(placeholder);
      }

      // VCT Name (bottom)
      //const name = document.createElement('div');
      //name.className = 'vct-name';
      //name.style.color = textColor;
      //name.textContent = item.name || '(unnamed)';

      // Logo (top-left): image → alt text
      if (logo){
        const logoWrap = document.createElement('div');
        logoWrap.className = 'logo-wrap';
        const img = document.createElement('img');
        img.alt = logoAlt || 'logo';
        img.loading = 'lazy';
        img.decoding = 'async';
        img.src = logo;
        logoWrap.appendChild(img);
        cardDiv.appendChild(logoWrap);
      } else if (logoAlt){
        const logoWrap = document.createElement('div');
        logoWrap.className = 'logo-wrap';
        const span = document.createElement('span');
        span.textContent = logoAlt;
        logoWrap.appendChild(span);
        cardDiv.appendChild(logoWrap);
      }

      //cardDiv.appendChild(name);

      // Make whole card clickable
      const link = document.createElement('a');
      link.href = item.vct || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      link.style.textDecoration = 'none';
      link.appendChild(cardDiv);

      // If no VCT URL, disable click feel
      if (!item.vct){
        link.href = '#';
        link.addEventListener('click', (e) => e.preventDefault());
        link.title = 'No VCT URL available';
        cardDiv.style.cursor = 'default';
      }

      return link;
    }

    // ---- Row rendering
    function renderRows(data){
      rows.innerHTML = '';
      if (Array.isArray(_resizePairs)) { _resizePairs.length = 0; }
      resultCount.textContent = `${data.length} result${data.length===1?'':'s'}`;
      if (!data.length) { rows.appendChild(emptyRow); return; }

      data.forEach(item => {
        const tr = document.createElement('tr');

        // Card (clickable)
        const tdCard = document.createElement('td');
        tdCard.appendChild(buildVCTCard(item));

        // Name
        const tdName = document.createElement('td');
        tdName.textContent = item.name || '(unnamed)';

        // Description
        const tdDescription = document.createElement('td');
        tdDescription.textContent = item.description || '(Unnamed)';

        // Claims
        const tdClaims = document.createElement('td');
        const claimsWrap = document.createElement('div');
        claimsWrap.className = 'claims-scroll';
        // Prefer the array "claims"; fallback to parsing the legacy string "claims_list"
        const claimsArr = Array.isArray(item.claims) ? item.claims
          : Array.isArray(item.claim_paths) ? item.claim_paths
          : String(item.claim_paths || item.claims_list || '')
              .split(/[,\s]+/)
              .filter(Boolean);

        if (claimsArr.length === 0) {
          claimsWrap.innerHTML = '<span class="note">(No claims)</span>';
        } else {
          // Render as a vertical list
          const frag = document.createDocumentFragment();
          claimsArr.forEach(p => {
            const div = document.createElement('div');
            div.className = 'claim-item';
            div.title = p;           // full path on hover
            div.textContent = p;     // e.g., "person.birthdate"
            frag.appendChild(div);
          });
          claimsWrap.appendChild(frag);
        }
        tdClaims.appendChild(claimsWrap);

        // Languages
        const tdLangs = document.createElement('td');
        const langs = Array.isArray(item.languages_supported) ? item.languages_supported : [];
        if (langs.length) {
          const wrap = document.createElement('div'); wrap.className='chips';
          langs.slice(0,6).forEach(l => { const c = document.createElement('span'); c.className='chip'; c.textContent = l; wrap.appendChild(c); });
          tdLangs.appendChild(wrap);
        } else {
          tdLangs.innerHTML = '<span class="note">—</span>';
        }

        // Popularity (read-only)
        const tdPop = document.createElement('td');
        tdPop.appendChild(renderStarsCell(item));

        // Actions
        const tdActions = document.createElement('td');

        const dl = document.createElement('a');
        dl.href = `/vct/registry/api/download/${item.id}`;
        dl.className = 'secondary-btn';
        dl.textContent = 'Download JSON';
        dl.setAttribute('title', 'Download VCT JSON');
        tdActions.appendChild(dl);

        // Copy VCT URL
        const copyVctBtn = document.createElement('button');
        copyVctBtn.type = 'button';
        copyVctBtn.className = 'ghost-btn';
        copyVctBtn.textContent = 'Copy VCT URL';
        copyVctBtn.title = item.vct || 'No VCT URL available';
        copyVctBtn.addEventListener('click', async () => {
          const ok = await copyText(item.vct);
          showToast(ok ? 'VCT URL copied' : 'No VCT URL to copy');
        });
        tdActions.appendChild(copyVctBtn);

        // Copy Integrity
        const copyIntBtn = document.createElement('button');
        copyIntBtn.type = 'button';
        copyIntBtn.className = 'ghost-btn';
        copyIntBtn.textContent = 'Copy integrity';
        copyIntBtn.title = item.integrity || 'Integrity not available';
        copyIntBtn.addEventListener('click', async () => {
          const ok = await copyText(item.integrity);
          showToast(ok ? 'Integrity copied' : 'No integrity value to copy');
        });
        tdActions.appendChild(copyIntBtn);

        // Extend button
        const ext = document.createElement('a');
        ext.className = 'secondary-btn';
        ext.textContent = 'Extend this VCT';
        ext.href = `/vct/registry/extend?row_id=${encodeURIComponent(item.id)}&integrity=${encodeURIComponent(item.integrity||'')}`;
        ext.title = 'Create a child VCT that extends this one';
        tdActions.appendChild(ext);

        // Disable buttons when values are missing
        if (!item.vct) copyVctBtn.disabled = true;
        if (!item.integrity) copyIntBtn.disabled = true;

        tr.appendChild(tdCard);
        tr.appendChild(tdName);
        tr.appendChild(tdDescription);
        tr.appendChild(tdClaims);
        tr.appendChild(tdLangs);
        tr.appendChild(tdPop);
        tr.appendChild(tdActions);
        rows.appendChild(tr);

        // Match Claims max-height to the card height for THIS row
        const cardEl = tdCard.querySelector('.vct-card');
        if (cardEl) {
          const h = cardEl.clientHeight || 0;
          if (h) claimsWrap.style.maxHeight = h + 'px';
          if (Array.isArray(_resizePairs)) {
            _resizePairs.push({ cardEl, claimsWrap });
          }
        }

      });
    }

    // --- Popular filters (EUDI use-cases) ---
    const POPULAR_FILTERS = [
      {key:"identity_auth", label:"Identity & authentication"},
      {key:"age_verification", label:"Age verification"},
      {key:"qes_signature", label:"Qualified eSignature (QES)"},
      {key:"payments_sca", label:"Payments: SCA"},
      {key:"bank_onboarding", label:"Bank onboarding (eKYC)"},
      {key:"iban_proof", label:"IBAN / account proof"},
      {key:"tickets_boarding", label:"Tickets & boarding"},
      {key:"hotel_checkin", label:"Hotel check-in"},
      {key:"mobility_vehicle", label:"Mobility & vehicle access"},
      {key:"address_residence", label:"Address / residence proof"},
      {key:"education", label:"Diplomas & student ID"},
      {key:"professional_licence", label:"Professional qualifications & licences"},
      {key:"eprescription", label:"ePrescription / health"},
      {key:"business_services", label:"Business services access"},
      {key:"crossborder_egov", label:"Cross-border public service access"}
    ];
    const filterGrid = document.getElementById('filter-grid');
    const filtersNote = document.getElementById('filters-note');
    let selectedFilter = null; // only one allowed

    function renderPopularFilters(){
      if (!filterGrid) return;
      filterGrid.innerHTML = '';
      POPULAR_FILTERS.forEach((f, idx) => {
        const id = `pf-${idx}`;
        const label = document.createElement('label');
        label.className = 'pill';
        label.innerHTML = `<input type="checkbox" id="${id}" data-key="${f.key}"><span>${f.label}</span>`;
        filterGrid.appendChild(label);
      });
      filterGrid.addEventListener('change', (e) => {
        const target = e.target.closest('input[type=checkbox]');
        if (!target) return;
        const key = target.getAttribute('data-key');
        if (target.checked) {
          // uncheck all others (single-select behavior using checkboxes)
          filterGrid.querySelectorAll('input[type=checkbox]').forEach(cb => {
            if (cb !== target) cb.checked = false;
          });
          selectedFilter = key;
        } else {
          selectedFilter = null;
        }
        // update active class
        filterGrid.querySelectorAll('.pill').forEach(p => {
          const cb = p.querySelector('input[type=checkbox]');
          p.classList.toggle('active', cb && cb.checked);
        });
        updateFiltersNote();
        refreshList();
      });
      // initialize from URL (if kw present)
      const u = new URL(location.href);
      const kw = u.searchParams.get('kw') || '';
      if (kw) {
        const cb = filterGrid.querySelector(`input[data-key="${kw}"]`);
        if (cb) { cb.checked = true; cb.dispatchEvent(new Event('change', {bubbles:true})); }
      } else {
        updateFiltersNote();
      }
    }

    function updateFiltersNote(){
      filtersNote.textContent = selectedFilter ? `Filter: ${POPULAR_FILTERS.find(f=>f.key===selectedFilter)?.label || selectedFilter}` : 'Tip: choose one filter or leave empty.';
    }

    function itemMatchesFilter(item, fkey){
      if (!fkey) return true;
      const text = ((item.name||'') + ' ' + (item.description||'') + ' ' + (item.search_text||'') + ' ' + (item.keywords||'')).toLowerCase();
      const claimHeads = new Set(
        Array.isArray(item.claims) ? item.claims.map(x => String(x).split(/[./]/)[0]) :
        Array.isArray(item.claim_paths) ? item.claim_paths.map(x => String(x).split(/[./]/)[0]) :
        String(item.claims_list||'').split(/[, \n\r\t]+/).map(x => String(x).split(/[./]/)[0])
      );
      const has = (kw) => text.includes(kw);
      const hasAny = (arr) => arr.some(has);
      const claimHas = (...heads) => heads.some(h => claimHeads.has(h));

      switch(fkey){
        case 'identity_auth':
          return hasAny(['identity','authentication','login','eid', 'PID']) || claimHas('given_name','family_name', 'first_name', 'birth_date');
        case 'age_verification':
          return hasAny(['age verification','age 18','over 18']) || claimHas('age_equal_or_over','age', 'age_over_18', 'over_18', 'over18');
        case 'qes_signature':
          return hasAny(['qes','qualified e-signature','qualified electronic signature','esignature','e-signature']);
        case 'payments_sca':
          return hasAny(['sca','strong customer authentication','payments','psd2']);
        case 'bank_onboarding':
          return hasAny(['ekyc','kyc','aml','onboarding','banking', 'bank account', 'payment']);
        case 'iban_proof':
          return hasAny(['iban','account ownership','account proof','bank account']);
        case 'tickets_boarding':
          return hasAny(['ticket','boarding','boarding pass','transport','flight','rail','bus']);
        case 'hotel_checkin':
          return hasAny(['hotel','check-in','check in','accommodation']);
        case 'mobility_vehicle':
          return hasAny(['mobility','driving license', 'mobile driver license', 'mdl', 'vehicle','rental','charging','parking']);
        case 'address_residence':
          return hasAny(['address','residence','residency']) || claimHas('street_address','city_address','postal_code','country_address');
        case 'education':
          return hasAny(['diploma','student','education','student card', 'university','degree','credential']);
        case 'professional_licence':
          return hasAny(['professional','certification','professional','qualification']);
        case 'eprescription':
          return hasAny(['eprescription','prescription','health','medical', 'health', 'health card']);
        case 'business_services':
          return hasAny(['business','b2b','b2g','enterprise', 'business wallet', 'employee', 'employer']);
        case 'crossborder_egov':
          return hasAny(['cross-border','egov','public service','eidas']);
        default:
          return true;
      }
    }


    // ---- Fetch helpers
    function buildParams(){
      const kw = selectedFilter;
      const p = new URLSearchParams();
      if (kw) p.set('kw', kw);
      p.set('scope', scopeSel.value);
      const q = searchInput.value.trim(); if (q) p.set('q', q);

      const sort = sortSel.value.trim(); if (sort) p.set('sort', sort);
      const langs = languagesInput.value.trim(); if (langs) p.set('languages', langs.toLowerCase());
      const prop = propInput.value.trim(); if (prop) p.set('prop', prop);
      const claim = claimInput.value.trim(); if (claim) p.set('claim', claim);
      const minr = minRatingInput.value.trim(); if (minr) p.set('min_rating', minr);
      const minc = minCallsInput.value.trim(); if (minc) p.set('min_calls', minc);
      if (hasSchemaInput.checked) p.set('has_schema','1');

      return p;
    }

    function syncURL(){
      const p = buildParams();
      const url = new URL(location.href);
      url.search = p.toString();
      history.replaceState(null, '', url.toString());
    }

    async function refreshList(){
      syncURL();
      if (aiToggle.checked){ return aiSearch(); }
      const params = buildParams();
      const resp = await fetch('/vct/registry/api/list?' + params.toString());
      if (!resp.ok) return;
      let data = await resp.json();
      if (selectedFilter) { data = data.filter(it => itemMatchesFilter(it, selectedFilter)); }
      renderRows(data);
    }

    async function aiSearch(){
      const body = Object.fromEntries(buildParams().entries());
      body.top_k = 50;
      const resp = await fetch('/vct/registry/api/ai_search', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if (!resp.ok){ return refreshList(); }
      let data = await resp.json();
      if (selectedFilter) { data = data.filter(it => itemMatchesFilter(it, selectedFilter)); }
      renderRows(data);
    }

    // ---- Debounce
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    const debounced = debounce(refreshList, 300);

    // ---- Events
    searchBtn.addEventListener('click', refreshList);
    resetBtn.addEventListener('click', () => {
      searchInput.value='';
      languagesInput.value='';
      propInput.value='';
      claimInput.value='';
      minRatingInput.value='';
      minCallsInput.value='';
      hasSchemaInput.checked=false;
      sortSel.value='';
      refreshList();
    });
    scopeSel.addEventListener('change', refreshList);
    sortSel.addEventListener('change', refreshList);
    hasSchemaInput.addEventListener('change', refreshList);
    [searchInput,languagesInput,propInput,claimInput,minRatingInput,minCallsInput].forEach(el=>{
      el.addEventListener('input', debounced);
    });
    aiToggle.addEventListener('change', refreshList);

    // ---- Initial state from URL
    (function loadFromURL(){
      const u = new URL(location.href);
      (u.searchParams.get('q')||'') && (searchInput.value = u.searchParams.get('q'));
      (u.searchParams.get('languages')||'') && (languagesInput.value = u.searchParams.get('languages'));
      (u.searchParams.get('prop')||'') && (propInput.value = u.searchParams.get('prop'));
      (u.searchParams.get('claim')||'') && (claimInput.value = u.searchParams.get('claim'));
      (u.searchParams.get('min_rating')||'') && (minRatingInput.value = u.searchParams.get('min_rating'));
      (u.searchParams.get('min_calls')||'') && (minCallsInput.value = u.searchParams.get('min_calls'));
      (u.searchParams.get('has_schema')==='1') && (hasSchemaInput.checked = true);
      (u.searchParams.get('sort')||'') && (sortSel.value = u.searchParams.get('sort'));
      (u.searchParams.get('scope')||'') && (scopeSel.value = u.searchParams.get('scope'));
    })();

    renderPopularFilters();
    // Initial load
    refreshList();
  </script>
</body>
</html>
