<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Continue with CONNECTORS</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      /* Brand hooks (override from server-side <style> if desired) */
      --brand: #05b6d3;         /* accent */
      --brand-2: #7c3aed;       /* secondary accent */
      --ink: #0b0f14;
      --muted: #586273;
      --surface: rgba(255,255,255,.66);
      --border: rgba(255,255,255,.35);
      --bg: #0b0f14;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --surface: rgba(18,20,26,.55);
        --border: rgba(255,255,255,.14);
        --ink: #e6edf5;
        --muted: #9fb0c6;
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      color: var(--ink);
      background: radial-gradient(1200px 700px at 10% -10%, #0b223a, var(--bg));
      min-height: 100vh;
      position: relative;
      overflow: hidden;
      display: grid;
      place-items: center;
      padding: 2rem;
    }

    /* Aurora blobs */
    .aurora::before,
    .aurora::after {
      content: ""; position: absolute; inset: -40%; pointer-events: none;
      filter: blur(60px) saturate(140%);
      transform: translateZ(0);
      background:
        radial-gradient(30% 25% at 18% 22%, rgba(5,182,211,.55), transparent 60%),
        radial-gradient(22% 18% at 70% 18%, rgba(124,58,237,.45), transparent 65%),
        radial-gradient(26% 22% at 84% 72%, rgba(5,182,211,.35), transparent 60%),
        radial-gradient(28% 26% at 24% 78%, rgba(124,58,237,.35), transparent 60%);
    }
    .aurora::after { transform: rotate(12deg) scale(1.1); opacity: .6; }

    /* Glass panel */
    .card {
      width: 100%; max-width: 880px;
      border-radius: 22px;
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: 0 20px 80px rgba(0,0,0,.35);
      backdrop-filter: blur(18px) saturate(140%);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
      overflow: clip;
    }

    .grid {
      display: grid; gap: 2rem; align-items: center;
      grid-template-columns: 1.05fr 0.95fr;
      padding: 1.75rem;
    }

    @media (max-width: 880px) { .grid { grid-template-columns: 1fr; } }

    .kicker { color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: .08em; font-size: .78rem; }
    .title { font-size: clamp(1.8rem, 1.2rem + 2vw, 2.6rem); margin: .25rem 0 .5rem; }
    .lede { color: var(--muted); margin: 0 0 1.2rem; }

    .actions { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; }
    .btn {
      appearance: none; border: 0; cursor: pointer; text-decoration: none;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #fff; font-weight: 700; border-radius: 999px;
      padding: .9rem 1.25rem; display: inline-flex; align-items: center; gap: .5rem;
      box-shadow: 0 10px 30px rgba(5,182,211,.28), 0 6px 16px rgba(124,58,237,.18);
      transition: transform .05s ease, filter .2s ease;
    }
    .btn:hover { filter: brightness(1.06); }
    .btn:active { transform: translateY(1px); }

    .chip { font-size: .85rem; color: var(--muted); border: 1px solid var(--border); border-radius: 999px; padding: .45rem .75rem; backdrop-filter: blur(6px); }

    .qr-wrap { display: grid; place-items: center; gap: .75rem; }
    .qr-card { background: rgba(255,255,255,.55); border: 1px solid var(--border); border-radius: 16px; padding: 1rem; box-shadow: 0 8px 30px rgba(0,0,0,.1); }
    @media (prefers-color-scheme: dark) { .qr-card { background: rgba(20,22,28,.55); } }

    .qr { width: 280px; height: 280px; border-radius: 12px; background: #fff; border: 1px solid rgba(0,0,0,.08); padding: .55rem; }
    .hint { color: var(--muted); text-align: center; font-size: .95rem; }

    .url-row { display: grid; grid-template-columns: 1fr auto; gap: .5rem; align-items: center; margin-top: .5rem; }
    .url-box { font-size: .9rem; color: var(--muted); background: rgba(255,255,255,.6); border: 1px solid var(--border); border-radius: 12px; padding: .6rem .75rem; word-break: break-all; }
    @media (prefers-color-scheme: dark) { .url-box { background: rgba(22,24,30,.5); } }
    .copy-btn { border: 1px solid var(--border); background: transparent; border-radius: 12px; padding: .55rem .8rem; cursor: pointer; color: var(--ink); }

    .meta { color: var(--muted); font-size: .82rem; text-align: center; margin-top: .75rem; }

    /* Tiny progress dot for SSE state */
    .status { display: inline-flex; align-items: center; gap: .4rem; color: var(--muted); font-size: .82rem; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #9aa4b2; box-shadow: 0 0 0 0 rgba(5,182,211,.0); transition: background .2s ease; }
    .dot.ok { background: var(--brand); box-shadow: 0 0 0 6px rgba(5,182,211,.15); }
  </style>
</head>
<body class="aurora">

  <main class="card" role="dialog" aria-labelledby="title" aria-describedby="desc">
    <section class="grid">
      <div>
        <div class="kicker">Wallet sign‑in</div>
        <h1 class="title" id="title">Continue with CONNECTORS</h1>
        <p class="lede" id="desc">Scan the QR with your wallet or open the link on this device to proceed securely.</p>

        <div class="actions">
          <a class="btn" href="{{ url }}" id="open-wallet">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 5v8m0 0 3-3m-3 3-3-3M5 19h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Continue in Wallet
          </a>
          <span class="chip">One‑time session</span>
          <span class="status"><span class="dot" id="sse-dot"></span>Waiting for confirmation…</span>
        </div>

        <div class="url-row" style="margin-top: 1rem;">
          <div class="url-box" id="deep-link" aria-label="Deep link">{{ url }}</div>
          <button class="copy-btn" id="copy">Copy</button>
        </div>

        <p class="meta">Session <code>{{ session_id }}</code></p>
      </div>

      <div class="qr-wrap">
        <div class="qr-card">
          <img class="qr" src="{{ qrcode(url) }}" alt="QR code for wallet sign-in" />
          <div class="hint">Scan with a compatible wallet</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Copy deep link
    document.getElementById('copy')?.addEventListener('click', async () => {
      const el = document.getElementById('deep-link');
      const text = el?.textContent?.trim() || '';
      try {
        await navigator.clipboard.writeText(text);
        const btn = document.getElementById('copy');
        if (btn) { const old = btn.textContent; btn.textContent = 'Copied'; setTimeout(() => btn.textContent = old, 1200); }
      } catch (e) { /* ignore */ }
    });

    // Live redirect when verification completes
    const dot = document.getElementById('sse-dot');
    const source = new EventSource('/signin/wallet/stream?session_id={{ session_id }}');
    source.onmessage = function (event) {
      try {
        const result = JSON.parse(event.data);
        if (!result) return;
        if (result.session_id === '{{ session_id }}') {
          dot?.classList.add('ok');
          if (result.status === 'complete') {
            window.location.href = '/signin/wallet/followup?session_id=' + result.session_id;
          }
        }
      } catch (e) { /* ignore */ }
    };
  </script>
</body>
</html>
