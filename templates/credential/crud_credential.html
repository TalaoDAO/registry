<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ 'Update' if mode=='update' else 'Create' }} Credential - CONNECTORS</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}">
  <style>
    .container { max-width: 800px; margin: 3rem auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    h1 { color: var(--primary); text-align: center; }
    form { display: grid; gap: 1rem; }
    form select { padding: 0.75rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; }
    label { margin-bottom: 0.25rem; display: block; font-weight: 600; }
    input[type="text"], textarea { padding: 0.75rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    textarea { min-height: 120px; }
    .button { background: var(--accent); color: white; border: none; padding: 0.75rem 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; }
    .flashes { margin: 1rem 0; color: green; font-weight: bold; }
    .advanced-toggle { display: inline-flex; align-items: center; gap: .5rem; padding: .5rem .75rem; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; width: fit-content; font-weight: 600; }
    .advanced-toggle:hover { background: #f2f2f2; }
    .chevron { transition: transform .2s ease; }
    .chevron[aria-hidden="true"] { display: inline-block; }
    .advanced-section { display: none; padding: 1rem; border: 1px dashed #e3e3e3; border-radius: 10px; background: #fcfcfc; }
    .advanced-section.show { display: block; }
    .hint { font-size: 0.9rem; color: #666; }
  </style>
</head>

<body>
<header>
  <div class="logo">
    <strong><a href="/" style="color: var(--primary); text-decoration: none;">CONNECTORS</a></strong>
  </div>
  <div class="nav-group">
    <nav>
      <a href="/menu">Menu</a>
      <a href="/credential/select">Select</a>
      <a href="/documentation/credential_create" target="_blank">Explain ?</a>
    </nav>
    {% include "account.html" %}
  </div>
</header>

<div class="container">
  {% if credential_type == "sandbox" %}
    <h1>{{ 'Update' if mode=='update' else 'Create' }} a Sandbox Key</h1>
  {% else %}
    <h1>{{ 'Update' if mode=='update' else 'Register' }} a Qualified Remote Credential</h1>
  {% endif %}

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flashes">
        {% for message in messages %}
          <p>{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="POST" enctype="multipart/form-data"
        action="{% if mode=='update' %}{{ url_for('update_credential', credential_type=credential_type, credential_id=credential.id) }}{% else %}{{ url_for('create_credential', credential_type=credential_type) }}{% endif %}">

    {% if credential_type == "sandbox" %}
      <label for="credential_ID">Key ID</label>
      <input type="text" id="credential_ID" name="credential_ID" placeholder="e.g. talao_credential" value="{{ credential_id or '' }}" {% if mode!='update' %}required{% endif %}>

      <label for="key">Private Key (JWK, JSON)</label>
      <textarea id="key" name="key" {% if mode!='update' %}required{% endif %} placeholder='{"kty":"EC","crv":"P-256","d":"...","x":"...","y":"...","alg":"ES256"}'>{{ key or '' }}</textarea>
      <div class="hint">
        {{ 'Leave empty to keep current encrypted value.' if mode=='update' else 'Used by credentials/issuers to sign requests. Paste a full private JWK (JSON).' }}
      </div>
    {% else %}
      <label for="Credential_ID">Credential ID</label>
      <!-- keep original select -->
      <select id="Credential_ID" name="Credential_ID" {% if mode!='update' %}required{% endif %}>
        {% for c in credentials %}
          <option value="{{ c }}" {% if (credential_id or '')==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    {% endif %}

    <!-- Advanced toggle -->
    <button type="button" class="advanced-toggle" id="advancedToggle" aria-expanded="false" aria-controls="advanced-section">
      <span class="chevron" id="chevron" aria-hidden="true">â–¸</span>
      Advanced options (encryption key, DID, attestation)
    </button>

    <!-- Advanced fields (hidden by default) -->
    <div id="advanced-section" class="advanced-section" role="region" aria-label="Advanced options">
      {% if credential_type == "sandbox" %}
        <label for="x509_der">X.509 Certificate (DER / CER)</label>
        <input type="file" id="x509_der" name="x509_der" accept=".der,.cer" />
        <div class="hint">We will store this certificate as Base64 (no headers) in <code>Credential.x509</code>.</div>
      {% endif %}

      <label for="x5c">Optional X.509 Certificate Chain (x5c, JSON array)</label>
      <textarea id="x5c" name="x5c" placeholder='["MIIC...base64...","MIIC...base64..."]'>{{ x5c or '' }}</textarea>
      <div class="hint">Base64 DER (no PEM headers), outermost leaf first. Needed if you use the x509_san_dns client_id scheme.</div>

      <label for="did">Optional DID</label>
      <input type="text" id="did" name="did" placeholder="did:key:..., did:web:..., did:ebsi:..." value="{{ did or '' }}">

      <label for="verification_method">Optional Verification Method (DID URL)</label>
      <input type="text" id="verification_method" name="verification_method" placeholder="did:example:123#key-1" value="{{ verification_method or '' }}">
    </div>

    {% if mode=='update' %}
      <button type="submit" class="button">Save changes</button>
    {% else %}
      {% if credential_type == "sandbox" %}
        <button type="submit" class="button">Create Credential</button>
      {% else %}
        <button type="submit" class="button">Register Credential</button>
      {% endif %}
    {% endif %}
  </form>
</div>

{% include "footer.html" %}

<script>
  function toggleDropdown(){var d=document.getElementById("dropdown"); if(!d)return; d.style.display=d.style.display==="block"?"none":"block";}
  window.onclick=function(e){if(!e.target.matches('.user-icon')){var d=document.getElementById("dropdown"); if(d&&d.style.display==="block"){d.style.display="none";}}};

  // Advanced toggle behavior
  function setupAdvancedToggle() {
    const btn = document.getElementById("advancedToggle");
    const section = document.getElementById("advanced-section");
    const chevron = document.getElementById("chevron");
    btn.addEventListener("click", () => {
      const isOpen = btn.getAttribute("aria-expanded") === "true";
      btn.setAttribute("aria-expanded", String(!isOpen));
      section.classList.toggle("show", !isOpen);
      chevron.style.transform = !isOpen ? "rotate(90deg)" : "rotate(0deg)";
    });
  }
  document.addEventListener("DOMContentLoaded", setupAdvancedToggle);
</script>
</body>
</html>
