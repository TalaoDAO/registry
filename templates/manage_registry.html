<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VCT Registry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}">
  <style>
    :root{ --blue:#1a73e8; --blue-dark:#1558b0; --surface:#ffffff; --border:#e3e3e3;
           --text:#202124; --subtext:#5f6368; --bg:#f8f9fa; --ok:#166534; --err:#991b1b; }
    body { margin:0; background:#f7f9fc; color:#333; font-family: Arial, sans-serif; }
    .section { max-width:1800px; margin:4rem auto; padding:0 2rem; }
    .card { width:100%; max-width:1650px; margin:0 auto; background:var(--surface); border:1px solid var(--border);
            border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.06); overflow:hidden; }
    .card-header { display:flex; align-items:center; gap:.75rem; padding:1rem 1.25rem; border-bottom:1px solid var(--border); }
    .app-mark { width:28px; height:28px; border-radius:6px; background:var(--blue); display:inline-flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:.95rem; }
    .title { margin:0; font-size:1rem; font-weight:700; font-family:'Roboto'; }
    .subtitle { margin:0; font-size:.9rem; color:#5f6368; font-weight:400; font-family:'Roboto'; }
    .card-body { padding:1.25rem; display:grid; gap:1rem; }
    .note { color:#5f6368; font-size:.9rem; }
    .primary-btn, .secondary-btn, .ghost-btn { appearance:none; border:none; cursor:pointer; text-decoration:none;
      padding:.8rem 1rem; border-radius:8px; font-weight:600; display:inline-flex; align-items:center; gap:.5rem;
      font-family:'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
    .primary-btn { background:var(--blue); color:#fff; }
    .primary-btn:hover { background:var(--blue-dark); }
    .secondary-btn { background:#edf2ff; color:#1f3b8a; border:1px solid #c7d2fe; }
    .ghost-btn { background:transparent; color:#111827; border:1px dashed var(--border); }
    input[type="text"], select { padding:.6rem .7rem; border:1px solid var(--border); border-radius:8px; min-width:220px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:.75rem 1rem; border-top:1px solid var(--border); text-align:left; font-size:.95rem; vertical-align: middle; }
    td:first-child .mono{ display:block; max-width:10rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    th { background:#f3f4f6; position:sticky; top:0; z-index:1; }
    tbody tr:hover { background:#fafafa; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:620px; display:inline-block; vertical-align:bottom; }
    .row-actions { display:flex; gap:.5rem; align-items:center; flex-wrap:nowrap; white-space:nowrap; overflow:auto; }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .toolbar .left, .toolbar .right { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .stars { display:inline-flex; gap:2px; cursor:pointer; user-select:none; }
    .star { font-size:1.1rem; color:#d1d5db; }
    .star.filled { color:#f59e0b; }
    .overlay { position:fixed; inset:0; background:rgba(255,255,255,.7); backdrop-filter: blur(2px);
               display:none; align-items:center; justify-content:center; z-index:50; }
    .spinner { width:46px; height:46px; border-radius:999px; border:4px solid #d1d5db; border-top-color:var(--blue);
               animation: spin 1s linear infinite; }
    .langs { display:flex; flex-wrap:wrap; gap:.35rem; align-items:center; }
    .lang { padding:.2rem .5rem; border:1px solid var(--border); border-radius:999px; font-size:.8rem; line-height:1; background:#f3f4f6; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (prefers-color-scheme: dark) {
      :root { --surface:#1f1f1f; --border:#2a2a2a; --text:#e8eaed; --subtext:#9aa0a6; --bg:#0f1113; }
      th { background:#0f172a; }
    }
  </style>
</head>

<body data-is-admin="{{ '1' if user and (user.is_admin or user.role == 'admin') else '0' }}">
  <header>
    <div class="logo">
      <strong><a href="/" style="color: var(--primary); text-decoration: none;">VC-REGISTRY.COM</a></strong>
    </div>
    <div class="nav-group">
      <nav>
        <a href="/menu">Menu</a>
        <a href="/documentation/manage_registry" target="_blank" rel="noopener">Explain ?</a>
      </nav>
      {% include "account.html" %}
    </div>
  </header>

  <main class="section">
    <h1 style="text-align:center; margin:0 0 .5rem 0;">Manage your VC Types</h1>
    <p class="note" style="text-align:center; margin:0 0 1.25rem 0;">
      Browse, search, and manage your VCT entries.
    </p>

    <article class="card" style="margin-top:1rem;" aria-labelledby="list-title">
      <header class="card-header">
        <div class="app-mark" aria-hidden="true">M</div>
        <div>
          <h2 class="title" id="list-title">Catalog</h2>
          <p class="subtitle">Browse your VCTs or explore the public catalog</p>
        </div>
      </header>
      <section class="card-body" style="padding:1rem; display:grid; gap:1rem;">
        <div class="toolbar">
          <div class="left">
            <select id="scope">
              {% if user and (user.is_admin or user.role == 'admin') %}
              <option value="my">My VCTs</option>
              <option selected value="public">Public Registry</option>
              <option value="robot">Robot</option>
              <option value="private">Private</option>
              {% else %}
               <option value="my" selected>My VCTs</option>
              <option value="public">Public Registry</option>
              {% endif %}
            </select>
            <input type="text" id="search" placeholder="Search by keywords… e.g. address, birthdate, diploma" />
            <label class="switch"><input type="checkbox" id="ai-toggle"> Use AI search</label>
            <button id="search-btn" class="secondary-btn" type="button">Search</button>
            <button id="reset-btn" class="ghost-btn" type="button">Reset</button>
          </div>
          <div class="right">
            <span class="note">Tip: try field names like <code>given_name</code>, <code>nationalities</code></span>
          </div>
        </div>

        <div style="overflow:auto; max-height:60vh;">
          <table>
            <thead>
              <tr>
                <th style="width:7rem;">Name</th>
                <th style="width:32rem;">Description</th>
                <th style="width:10rem;">Languages</th>
                  <th style="width:7rem;">Claims</th>
                <th style="width:14rem;">Popularity</th>
                <th style="width:7rem;">Visible</th>
                <th style="width:28rem;">Actions</th>
              </tr>
            </thead>

            <tbody id="rows">
              <tr id="empty-row"><td colspan="6" class="note" style="padding:1rem;">No entries yet.</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </article>
  </main>

  {% include "footer.html" %}

  <div class="overlay" id="overlay">
    <div style="display:flex; flex-direction:column; align-items:center; gap:.75rem;">
      <div class="spinner"></div>
      <div class="mono">Working…</div>
    </div>
  </div>

  <script>
  // --- DOM Refs ---
  const rows = document.getElementById('rows');
  const emptyRow = document.getElementById('empty-row');
  const overlay = document.getElementById('overlay');
  const scopeSel = document.getElementById('scope');
  const searchInput = document.getElementById('search');
  const aiToggle = document.getElementById('ai-toggle');
  const searchBtn = document.getElementById('search-btn');
  const resetBtn = document.getElementById('reset-btn');
  const IS_ADMIN = (document.body.getAttribute('data-is-admin') === '1');

  const VALID_SCOPES = new Set(['my','public','private','all']);

  const normScope = (s) => {
    s = String(s || '').toLowerCase();
    // Map unknown scopes (e.g., "robot") to "all" to avoid server-side fall-through
    return VALID_SCOPES.has(s) ? s : 'all';
  };

  const overlayOn = (on) => { overlay.style.display = on ? 'flex' : 'none'; };

  async function copyText(text){
    try { await navigator.clipboard.writeText(text || ''); }
    catch { /* no-op if clipboard is unavailable */ }
  }

  function starEl(f){ const s = document.createElement('span'); s.className='star'+(f?' filled':''); s.textContent='★'; return s; }
  function renderStarsCell(item){
    const wrap = document.createElement('div');
    const stars = document.createElement('div'); stars.className = 'stars';
    const rounded = Math.round((item.your_rating || item.avg_rating || 0));
    for (let i=1;i<=5;i++){
      const el = starEl(i<=rounded);
      el.title = item.your_rating ? `Your rating: ${item.your_rating}★` :
                                    `Average: ${Number(item.avg_rating||0).toFixed(1)}★ (${item.ratings_count||0})`;
      el.addEventListener('click', () => rate(item.id, i));
      stars.appendChild(el);
    }
    const meta = document.createElement('div');
    meta.className='note';
    meta.textContent = `${(item.avg_rating||0).toFixed(1)}★ • ${item.ratings_count||0} ratings • ${item.calls_count||0} calls`;
    wrap.appendChild(stars); wrap.appendChild(meta);
    return wrap;
  }

  async function rate(id, stars){
    overlayOn(true);
    try{
      const r = await fetch('/vct/registry/api/rate/' + id, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({stars})
      });
      const d = await r.json().catch(()=>({}));
      if(!r.ok) throw new Error(d.error || 'Rating failed');
      await refreshList();
    }catch(e){ alert(e.message); }
    finally{ overlayOn(false); }
  }

  // URL <-> UI sync
  const setUrlScope = (scope) => {
    const url = new URL(window.location.href);
    url.searchParams.set('scope', scope);
    window.history.replaceState({}, '', url);
  };
  const getUrlScope = () => {
    const url = new URL(window.location.href);
    return normScope(url.searchParams.get('scope') || '');
  };

  async function refreshList(){
    overlayOn(true);
    try {
      const scope = normScope(scopeSel.value);
      setUrlScope(scope);

      // Disable AI search on "private" to avoid server’s double user_id filter quirk
      const aiWanted = aiToggle.checked && scope !== 'private';

      const q = searchInput.value.trim();
      if (aiWanted){
        const resp = await fetch('/vct/registry/api/ai_search', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ scope, q, top_k: 50 })
        });
        if (resp.ok){
          const data = await resp.json();
          renderRows(data);
          return;
        }
        // If AI fails (403/500/etc), fall back to normal list
      }

      const params = new URLSearchParams({ scope, q });
      const resp = await fetch('/vct/registry/api/list?' + params.toString());
      if (!resp.ok){
        console.error('List failed', resp.status);
        renderRows([]);
        return;
      }
      const data = await resp.json();
      renderRows(data);
    } catch (e){
      console.error(e);
      renderRows([]);
    } finally {
      overlayOn(false);
    }
  }

  function renderRows(data){
    rows.innerHTML = '';
    if (!Array.isArray(data) || !data.length) { rows.appendChild(emptyRow); return; }

    data.forEach(item => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td'); 
      tdName.innerHTML = `<a href="${item.vct}" target="_blank" rel="noopener" class="mono" title="${item.name}">${item.name}</a>`;

      const tdDescription = document.createElement('td');
      tdDescription.textContent = item.description || '(unnamed)';

      const tdLang = document.createElement('td');
      const langWrap = document.createElement('div'); langWrap.className = 'langs';
      const langs = Array.isArray(item.languages_supported) ? item.languages_supported : [];
      if (langs.length) {
        langs.forEach(code => {
          const chip=document.createElement('span'); chip.className='lang'; chip.textContent=String(code||'').toUpperCase();
          langWrap.appendChild(chip);
        });
      } else {
        const none=document.createElement('span'); none.className='note'; none.textContent='—';
        langWrap.appendChild(none);
      }
      tdLang.appendChild(langWrap);


      // Schema props count
      const tdSchemaProps = document.createElement('td');
      const count = Number(item.schema_props_count || 0);
      tdSchemaProps.textContent = isNaN(count) ? '—' : String(count);

      const tdPop  = document.createElement('td'); tdPop.appendChild(renderStarsCell(item));

      const tdVis  = document.createElement('td');
      const vis = document.createElement('button'); vis.type='button';
      vis.className='secondary-btn'; vis.textContent = item.is_public ? 'Public' : 'Private';
      if (item.can_modify === false){ vis.disabled = true; vis.title = 'You can only change visibility of your own VC Types.'; }
      
    
      vis.addEventListener('click', async () => {
        if (vis.disabled) return;

        const newIsPublic = !item.is_public;

        // Ask for explicit confirmation when going Public -> Private
        if (item.is_public && !newIsPublic) {
          const ok = confirm(
      `Are you sure you want to make this VC Type PRIVATE?

      Consequences:
      • The public VCT URL will stop working (links will break)
      • It will disappear from public search/catalog
      • API downloads will be blocked
      • Any cached/public references may fail in dependent systems

      Proceed with making it private?`
          );
          if (!ok) return; // user canceled; do nothing
        }

        overlayOn(true);
        try {
          const r = await fetch('/vct/registry/api/visibility/' + item.id, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_public: newIsPublic })
          });
          const d = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(d.error || 'Failed to change visibility');
          await refreshList();
        } catch (e) {
          alert(e.message);
        } finally {
          overlayOn(false);
        }
      });

      tdVis.appendChild(vis);

      const tdAct  = document.createElement('td'); tdAct.className='row-actions';
      const dlVct = document.createElement('a'); dlVct.className='secondary-btn'; dlVct.textContent='Download VCT'; dlVct.href='/vct/registry/api/download/' + item.id;
      const copyVctBtn = document.createElement('button'); copyVctBtn.type='button'; copyVctBtn.className='ghost-btn'; copyVctBtn.textContent='Copy VCT URL'; copyVctBtn.addEventListener('click', () => copyText(item.vct || ''));
      const copyIntBtn = document.createElement('button'); copyIntBtn.type='button'; copyIntBtn.className='ghost-btn'; copyIntBtn.textContent='Copy integrity'; copyIntBtn.addEventListener('click', () => copyText(item.integrity || ''));
      const score = document.createElement('span'); if (typeof item.score !== 'undefined'){ score.className='note'; score.textContent = `score: ${Number(item.score).toFixed(2)}`; }

     
     

      tdAct.appendChild(dlVct);
      tdAct.appendChild(copyVctBtn);
      tdAct.appendChild(copyIntBtn);
      //if (score.textContent) tdAct.appendChild(score);
      

      // Extend button → pass row_id and integrity
      const ext = document.createElement('a');
      ext.className = 'secondary-btn';
      ext.textContent = 'Extend this VCT';
      ext.href = `/vct/registry/extend?row_id=${encodeURIComponent(item.id)}&integrity=${encodeURIComponent(item.integrity||'')}`;
      ext.title = 'Create a child VCT that extends this one';
      tdAct.appendChild(ext);


       // Edit button
      const edit = document.createElement('a');
      edit.className = 'secondary-btn';
      edit.textContent = 'Edit';
      edit.href = '/vct/registry/editor/' + encodeURIComponent(item.id);
      edit.title = 'Edit this VC Type in place';
      tdAct.appendChild(edit);

      if (item.can_modify !== false) {
        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'secondary-btn';
        del.textContent = 'Delete';

        del.addEventListener('click', async () => {
          const name = item.name || 'this VC Type';
          const msg = [
            `Delete “${name}”?`,
            '',
            'This will permanently remove this VC Type.',
            '',
            'Consequences:',
            '• The VCT URL will stop working',
            '• It will be removed from search/catalog',
            '• Dependent systems referencing this VCT may fail',
            '',
            'This action cannot be undone.',
            ''
          ].filter(Boolean).join('\n');

          if (!window.confirm(msg)) return;

          const prevText = del.textContent;
          del.disabled = true;
          del.textContent = 'Deleting…';
          overlayOn(true);

          try {
            const r = await fetch('/vct/registry/api/delete/' + encodeURIComponent(item.id), { method: 'POST' });
            const d = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(d.error || 'Delete failed');
            await refreshList();
          } catch (e) {
            alert(e.message || 'Delete failed');
          } finally {
            overlayOn(false);
            del.disabled = false;
            del.textContent = prevText;
          }
        });

        tdAct.appendChild(del);
      }


      tr.appendChild(tdName);
      tr.appendChild(tdDescription);
      tr.appendChild(tdLang);
      tr.appendChild(tdSchemaProps);   
      tr.appendChild(tdPop);
      tr.appendChild(tdVis);
      tr.appendChild(tdAct);
      rows.appendChild(tr);
    });
  }

  // --- Events ---
  searchBtn.addEventListener('click', refreshList);
  resetBtn.addEventListener('click', () => { searchInput.value=''; refreshList(); });

  // Make the select very responsive across browsers/AT
  scopeSel.addEventListener('change', refreshList);
  scopeSel.addEventListener('input', (e) => {
    if (e.target === scopeSel) refreshList();
  });

  // If scope is "private", don't allow AI search (server quirk). Also re-check on toggle.
  aiToggle.addEventListener('change', () => {
    if (normScope(scopeSel.value) === 'private' && aiToggle.checked){
      aiToggle.checked = false;
    }
    refreshList();
  });

  // initial load: pick a REAL option from the <select>
  (function init() {
    const url = new URL(window.location.href);
    const fromUrlRaw = String(url.searchParams.get('scope') || '').toLowerCase(); // raw from URL
    const optionValues = [...scopeSel.options].map(o => o.value);
    const defaultUi = IS_ADMIN ? 'public' : 'my';

    // If URL scope is one of the UI options, use it; otherwise use defaultUi
    const uiScope = optionValues.includes(fromUrlRaw) ? fromUrlRaw : defaultUi;
    scopeSel.value = uiScope;                    // what the user sees in the dropdown
    setUrlScope(normScope(uiScope));             // what we send to the API / keep in the URL
    refreshList();
  })();
</script>

</body>
</html>
